import static spark.Spark.*;
import spark.Session;

import com.google.gson.Gson;

import javax.servlet.MultipartConfigElement;
import javax.servlet.http.Part;
import java.io.*;
import java.nio.file.Paths;
import java.util.*;
import java.util.concurrent.*;

public class Main {

    private static final int MAX_LOGIN_ATTEMPTS = 5;
    private static final int LOGIN_COOLDOWN_MINUTES = 5;
    private static final int AFK_LOGOUT_MINUTES = 30;
    private static final int MAX_CHAT_MESSAGES = 500;

    private static final String ADMIN_USER = "admin";
    private static final String ADMIN_PASS = "adminpass";
    private static final String NORMAL_USER = "user";
    private static final String USER_PASS = "userpass";

    private static final String SESSION_ROLE = "role";
    private static final String SESSION_USERNAME = "username";
    private static final String SESSION_LAST_ACTIVITY = "lastActivity";

    private static final Map<String, LoginAttemptInfo> loginAttempts = new ConcurrentHashMap<>();
    private static final List<ChatMessage> chatMessages = Collections.synchronizedList(new LinkedList<>());

    private static final Gson gson = new Gson();

    public static void main(String[] args) {
        ipAddress("abdik9292.github.io");
        port(8080);

        enableCORS("*", "GET,POST,OPTIONS", "Content-Type,Authorization");

        before((req, res) -> {
            Session session = req.session(false);
            if (session != null && session.attribute(SESSION_ROLE) != null) {
                session.attribute(SESSION_LAST_ACTIVITY, System.currentTimeMillis());
            }
        });

        // Basic AFK cleaner placeholder
        ScheduledExecutorService afkCleaner = Executors.newSingleThreadScheduledExecutor();
        afkCleaner.scheduleAtFixedRate(() -> {
            // Placeholder for session cleanup
        }, 1, 1, TimeUnit.MINUTES);

        get("/Abdik-web/", (req, res) -> {
            res.redirect("/Abdik-web/login");
            return null;
        });

        // LOGIN HTML FORM (for browser)
        get("/Abdik-web/login", (req, res) -> """
            <h2>Login</h2>
            <form method='POST'>
                Username: <input name='username' required><br>
                Password: <input name='password' type='password' required><br>
                <button type='submit'>Login</button>
            </form>
        """);

        // LOGIN API - JSON version for Unity
        post("/Abdik-web/api/login", (req, res) -> {
            res.type("application/json");
            String user = req.queryParams("username");
            String pass = req.queryParams("password");
            String ip = req.ip();

            if (user == null || pass == null || user.isEmpty() || pass.isEmpty()) {
                return gson.toJson(Map.of("success", false, "error", "Missing username or password"));
            }

            LoginAttemptInfo attemptInfo = loginAttempts.getOrDefault(ip, new LoginAttemptInfo());
            long now = System.currentTimeMillis();

            if (attemptInfo.blockUntil > now) {
                long secondsLeft = (attemptInfo.blockUntil - now) / 1000;
                return gson.toJson(Map.of("success", false, "error", "Too many failed attempts. Try again in " + secondsLeft + " seconds."));
            }

            boolean isAdmin = ADMIN_USER.equals(user) && ADMIN_PASS.equals(pass);
            boolean isUser = NORMAL_USER.equals(user) && USER_PASS.equals(pass);

            if (isAdmin || isUser) {
                attemptInfo.reset();
                loginAttempts.put(ip, attemptInfo);

                Session session = req.session(true);
                session.attribute(SESSION_USERNAME, user);
                session.attribute(SESSION_ROLE, isAdmin ? "admin" : "user");
                session.attribute(SESSION_LAST_ACTIVITY, now);

                return gson.toJson(Map.of("success", true, "role", isAdmin ? "admin" : "user"));
            } else {
                attemptInfo.failedCount++;
                attemptInfo.lastFailed = now;
                if (attemptInfo.failedCount >= MAX_LOGIN_ATTEMPTS) {
                    attemptInfo.blockUntil = now + LOGIN_COOLDOWN_MINUTES * 60_000L;
                    attemptInfo.failedCount = 0;
                }
                loginAttempts.put(ip, attemptInfo);

                return gson.toJson(Map.of("success", false, "error", "Invalid credentials"));
            }
        });

        // LOGIN POST FOR BROWSER (keep your original login POST to serve browser)
        post("/Abdik-web/login", (req, res) -> {
            String user = req.queryParams("username");
            String pass = req.queryParams("password");
            String ip = req.ip();

            if (user == null || pass == null || user.isEmpty() || pass.isEmpty()) {
                return "<p>Missing username or password.</p><a href='/Abdik-web/login'>Try again</a>";
            }

            LoginAttemptInfo attemptInfo = loginAttempts.getOrDefault(ip, new LoginAttemptInfo());
            long now = System.currentTimeMillis();

            if (attemptInfo.blockUntil > now) {
                long secondsLeft = (attemptInfo.blockUntil - now) / 1000;
                return "<p>Too many failed attempts. Try again in " + secondsLeft + " seconds.</p><a href='/Abdik-web/login'>Back</a>";
            }

            boolean isAdmin = ADMIN_USER.equals(user) && ADMIN_PASS.equals(pass);
            boolean isUser = NORMAL_USER.equals(user) && USER_PASS.equals(pass);

            if (isAdmin || isUser) {
                attemptInfo.reset();
                loginAttempts.put(ip, attemptInfo);

                Session session = req.session(true);
                session.attribute(SESSION_USERNAME, user);
                session.attribute(SESSION_ROLE, isAdmin ? "admin" : "user");
                session.attribute(SESSION_LAST_ACTIVITY, now);

                res.redirect(isAdmin ? "/Abdik-web/admin" : "/Abdik-web/user");
                return null;
            } else {
                attemptInfo.failedCount++;
                attemptInfo.lastFailed = now;
                if (attemptInfo.failedCount >= MAX_LOGIN_ATTEMPTS) {
                    attemptInfo.blockUntil = now + LOGIN_COOLDOWN_MINUTES * 60_000L;
                    attemptInfo.failedCount = 0;
                }
                loginAttempts.put(ip, attemptInfo);

                return "<p>Invalid credentials.</p><a href='/Abdik-web/login'>Try again</a>";
            }
        });

        // AUTH MIDDLEWARE FOR ADMIN
        before("/Abdik-web/admin", (req, res) -> {
            Session session = req.session(false);
            if (session == null || !"admin".equals(session.attribute(SESSION_ROLE))) {
                res.redirect("/Abdik-web/login");
                halt();
            }
        });

        // ADMIN PAGE
        get("/Abdik-web/admin", (req, res) -> {
            Session session = req.session();
            return adminPageHtml(session);
        });

        // AUTH MIDDLEWARE FOR USER & ADMIN
        before("/Abdik-web/user", (req, res) -> {
            Session session = req.session(false);
            if (session == null || (!"user".equals(session.attribute(SESSION_ROLE)) && !"admin".equals(session.attribute(SESSION_ROLE)))) {
                res.redirect("/Abdik-web/login");
                halt();
            }
        });

        // USER PAGE
        get("/Abdik-web/user", (req, res) -> {
            Session session = req.session();
            return userPageHtml(session);
        });

        // LOGOUT API for Unity
        post("/Abdik-web/api/logout", (req, res) -> {
            Session session = req.session(false);
            if (session != null) {
                session.invalidate();
            }
            res.type("application/json");
            return gson.toJson(Map.of("success", true));
        });

        // LOGOUT BROWSER GET
        get("/Abdik-web/logout", (req, res) -> {
            Session session = req.session(false);
            if (session != null) session.invalidate();
            res.redirect("/Abdik-web/login");
            return null;
        });

        // CHAT SEND - JSON API for Unity and browser form
        post("/Abdik-web/api/chat/send", (req, res) -> {
            res.type("application/json");
            Session session = req.session(false);
            if (session == null || session.attribute(SESSION_ROLE) == null) {
                res.status(403);
                return gson.toJson(Map.of("success", false, "error", "Not logged in"));
            }
            String username = session.attribute(SESSION_USERNAME);
            String role = session.attribute(SESSION_ROLE);

            String message = req.queryParams("message");
            if (message == null || message.trim().isEmpty()) {
                return gson.toJson(Map.of("success", false, "error", "Empty message not allowed"));
            }
            message = message.trim();

            ChatMessage chatMsg = new ChatMessage(username, role, message, System.currentTimeMillis());

            synchronized (chatMessages) {
                chatMessages.add(chatMsg);
                if (chatMessages.size() > MAX_CHAT_MESSAGES) {
                    chatMessages.remove(0);
                }
            }

            return gson.toJson(Map.of("success", true));
        });

        // CHAT GET MESSAGES
        get("/Abdik-web/api/chat/messages", (req, res) -> {
            res.type("application/json");
            synchronized (chatMessages) {
                return gson.toJson(chatMessages);
            }
        });

        // FILE UPLOAD HTML FORM
        get("/Abdik-web/upload", (req, res) -> {
            Session session = req.session(false);
            if (session == null || session.attribute(SESSION_ROLE) == null) {
                res.redirect("/Abdik-web/login");
                return null;
            }
            return """
                <h2>Upload a file</h2>
                <form method="post" enctype="multipart/form-data">
                    <input type="file" name="file" required>
                    <button type="submit">Upload</button>
                </form>
                <a href="/Abdik-web/">Home</a>
            """;
        });

        // FILE UPLOAD HANDLER
        post("/Abdik-web/upload", (req, res) -> {
            Session session = req.session(false);
            if (session == null || session.attribute(SESSION_ROLE) == null) {
                res.status(403);
                return "Not logged in";
            }

            // Configure multipart config for file upload
            MultipartConfigElement multipartConfigElement = new MultipartConfigElement("/tmp");
            req.raw().setAttribute("org.eclipse.jetty.multipartConfig", multipartConfigElement);

            Part filePart = null;
            try {
                filePart = req.raw().getPart("file");
                if (filePart == null) {
                    return "No file uploaded";
                }

                String submittedFileName = Paths.get(filePart.getSubmittedFileName()).getFileName().toString();
                // Save file to disk or memory (example: save to uploads folder)
                File uploadsDir = new File("uploads");
                if (!uploadsDir.exists()) {
                    uploadsDir.mkdirs();
                }
                File file = new File(uploadsDir, submittedFileName);

                try (InputStream input = filePart.getInputStream()) {
                    try (OutputStream output = new FileOutputStream(file)) {
                        byte[] buffer = new byte[1024];
                        int read;
                        while ((read = input.read(buffer)) != -1) {
                            output.write(buffer, 0, read);
                        }
                    }
                }

                // You can add your code here to send the file to Discord or do other stuff

                return "<p>File uploaded: " + submittedFileName + "</p><a href='/Abdik-web/upload'>Upload another</a>";
            } finally {
                if (filePart != null) filePart.delete();
            }
        });

        // OPTIONS requests support for CORS preflight
        options("/*", (request, response) -> {
            String accessControlRequestHeaders = request.headers("Access-Control-Request-Headers");
            if (accessControlRequestHeaders != null) {
                response.header("Access-Control-Allow-Headers", accessControlRequestHeaders);
            }

            String accessControlRequestMethod = request.headers("Access-Control-Request-Method");
            if (accessControlRequestMethod != null) {
                response.header("Access-Control-Allow-Methods", accessControlRequestMethod);
            }
            return "OK";
        });
    }

    private static String adminPageHtml(Session session) {
        return """
            <h2>Admin Panel</h2>
            <p>Welcome, %s (admin)</p>
            <a href="/Abdik-web/logout">Logout</a><br>
            <a href="/Abdik-web/upload">Upload Files</a><br>
            <h3>Chat Messages</h3>
            <div id="chat"></div>
            <form id="chatForm">
                <input id="msg" autocomplete="off" required><button>Send</button>
            </form>
            <script>
            const chatDiv = document.getElementById('chat');
            const form = document.getElementById('chatForm');
            form.addEventListener('submit', async e => {
                e.preventDefault();
                const msg = document.getElementById('msg').value;
                if(!msg) return;
                const res = await fetch('/Abdik-web/api/chat/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: 'message=' + encodeURIComponent(msg)
                });
                document.getElementById('msg').value = '';
            });
            async function fetchMessages() {
                const res = await fetch('/Abdik-web/api/chat/messages');
                const data = await res.json();
                chatDiv.innerHTML = data.map(m => '<b>' + m.username + ':</b> ' + m.message).join('<br>');
            }
            setInterval(fetchMessages, 1000);
            fetchMessages();
            </script>
        """.formatted(session.attribute("username"));
    }

    private static String userPageHtml(Session session) {
        return """
            <h2>User Panel</h2>
            <p>Welcome, %s</p>
            <a href="/Abdik-web/logout">Logout</a><br>
            <h3>Chat Messages</h3>
            <div id="chat"></div>
            <form id="chatForm">
                <input id="msg" autocomplete="off" required><button>Send</button>
            </form>
            <script>
            const chatDiv = document.getElementById('chat');
            const form = document.getElementById('chatForm');
            form.addEventListener('submit', async e => {
                e.preventDefault();
                const msg = document.getElementById('msg').value;
                if(!msg) return;
                const res = await fetch('/Abdik-web/api/chat/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: 'message=' + encodeURIComponent(msg)
                });
                document.getElementById('msg').value = '';
            });
            async function fetchMessages() {
                const res = await fetch('/Abdik-web/api/chat/messages');
                const data = await res.json();
                chatDiv.innerHTML = data.map(m => '<b>' + m.username + ':</b> ' + m.message).join('<br>');
            }
            setInterval(fetchMessages, 1000);
            fetchMessages();
            </script>
        """.formatted(session.attribute("username"));
    }

    private static class LoginAttemptInfo {
        int failedCount = 0;
        long lastFailed = 0;
        long blockUntil = 0;

        void reset() {
            failedCount = 0;
            lastFailed = 0;
            blockUntil = 0;
        }
    }

    private static class ChatMessage {
        String username;
        String role;
        String message;
        long timestamp;

        ChatMessage(String username, String role, String message, long timestamp) {
            this.username = username;
            this.role = role;
            this.message = message;
            this.timestamp = timestamp;
        }
    }

    // Enable CORS
    private static void enableCORS(final String origin, final String methods, final String headers) {
        options("/*", (request, response) -> {
            String accessControlRequestHeaders = request.headers("Access-Control-Request-Headers");
            if (accessControlRequestHeaders != null) {
                response.header("Access-Control-Allow-Headers", accessControlRequestHeaders);
            }
            String accessControlRequestMethod = request.headers("Access-Control-Request-Method");
            if (accessControlRequestMethod != null) {
                response.header("Access-Control-Allow-Methods", accessControlRequestMethod);
            }
            return "OK";
        });

        before((request, response) -> {
            response.header("Access-Control-Allow-Origin", origin);
            response.header("Access-Control-Request-Method", methods);
            response.header("Access-Control-Allow-Headers", headers);
            // Note: this may be set on each response automatically
        });
    }
}
