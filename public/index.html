<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>User Panel</title>
<style>
  /* Basic Reset and Fonts */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #2c3e50, #4ca1af);
    color: #eee;
    margin: 0;
    padding: 0;
  }
  .container {
    max-width: 900px;
    margin: 2rem auto;
    background: rgba(20, 20, 20, 0.9);
    border-radius: 10px;
    padding: 1.5rem 2rem;
    box-shadow: 0 0 15px #0ef;
  }
  h1 {
    text-align: center;
    margin-bottom: 1.5rem;
    color: #0ef;
  }

  form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  label {
    font-weight: 600;
  }

  input[type="text"],
  input[type="password"],
  input[type="file"] {
    padding: 0.6rem;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
  }

  input[type="submit"], button {
    background-color: #0ef;
    border: none;
    padding: 0.8rem;
    font-weight: 700;
    font-size: 1rem;
    border-radius: 8px;
    color: #111;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  input[type="submit"]:hover,
  button:hover {
    background-color: #08a;
    color: #ddd;
  }

  .error {
    background-color: #ff4c4c;
    color: #fff;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
  }

  .success {
    background-color: #4caf50;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
  }

  .profile-pic-preview {
    margin-top: 0.8rem;
    max-width: 150px;
    max-height: 150px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #0ef;
    box-shadow: 0 0 8px #0efaa;
  }

  .upload-section {
    margin-top: 1rem;
    background: #111;
    padding: 1rem;
    border-radius: 8px;
  }

  .upload-section label {
    display: block;
    margin-bottom: 0.5rem;
    color: #0ef;
  }

  .upload-section input[type="file"] {
    background: #222;
    color: #eee;
  }

  .user-info {
    margin-top: 1rem;
    background: #222;
    padding: 1rem;
    border-radius: 8px;
  }

  .logout-btn {
    margin-top: 1rem;
    background-color: #e74c3c;
    color: white;
    border: none;
    padding: 0.8rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
  }
  .logout-btn:hover {
    background-color: #c0392b;
  }

</style>
</head>
<body>
  <div class="container">
    <h1>User Panel</h1>

    <div id="messages"></div>

    <!-- Username Display -->
    <div class="user-info" id="userInfo" style="display:none;">
      <strong>Welcome, <span id="displayUsername"></span></strong>
      <br />
      <img id="pfpPreview" src="" alt="Profile Picture" class="profile-pic-preview" style="display:none;" />
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>

    <!-- Login/Register Form -->
    <form id="authForm">
      <label for="usernameInput">Username</label>
      <input
        type="text"
        id="usernameInput"
        name="username"
        minlength="3"
        maxlength="16"
        required
        placeholder="3 to 16 characters"
        pattern="^[a-zA-Z0-9_]+$"
        title="Alphanumeric and underscore only"
      />

      <label for="passwordInput">Password</label>
      <input
        type="password"
        id="passwordInput"
        name="password"
        minlength="8"
        required
        placeholder="At least 8 characters"
      />

      <button type="submit" id="authSubmitBtn">Login</button>
      <button type="button" id="toggleRegisterBtn" style="margin-top:0.5rem; background:#0a74da; color:#eee;">
        Switch to Register
      </button>
    </form>

    <!-- Profile Picture Upload -->
    <div class="upload-section" id="pfpSection" style="display:none;">
      <label for="pfpUpload">Upload Profile Picture (PNG, JPG, JPEG, GIF, WEBP, BMP) - Max 10MB</label>
      <input type="file" id="pfpUpload" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp,image/bmp" />
      <button id="pfpUploadBtn" disabled>Upload Profile Picture</button>
    </div>

    <!-- File Upload -->
    <div class="upload-section" id="fileUploadSection" style="display:none;">
      <label for="fileUpload">Upload Files (Max 125MB)</label>
      <input type="file" id="fileUpload" />
      <button id="fileUploadBtn" disabled>Upload File</button>
    </div>
  </div>

<script>
  const authForm = document.getElementById('authForm');
  const toggleRegisterBtn = document.getElementById('toggleRegisterBtn');
  const authSubmitBtn = document.getElementById('authSubmitBtn');
  const usernameInput = document.getElementById('usernameInput');
  const passwordInput = document.getElementById('passwordInput');
  const messagesDiv = document.getElementById('messages');

  const userInfoDiv = document.getElementById('userInfo');
  const displayUsernameSpan = document.getElementById('displayUsername');
  const logoutBtn = document.getElementById('logoutBtn');

  const pfpSection = document.getElementById('pfpSection');
  const pfpUploadInput = document.getElementById('pfpUpload');
  const pfpUploadBtn = document.getElementById('pfpUploadBtn');
  const pfpPreview = document.getElementById('pfpPreview');

  const fileUploadSection = document.getElementById('fileUploadSection');
  const fileUploadInput = document.getElementById('fileUpload');
  const fileUploadBtn = document.getElementById('fileUploadBtn');

  let isRegisterMode = false;

  function showMessage(msg, type = 'error') {
    messagesDiv.innerHTML = `<div class="${type}">${msg}</div>`;
    setTimeout(() => {
      messagesDiv.innerHTML = '';
    }, 4000);
  }

  // Toggle between Login and Register
  toggleRegisterBtn.addEventListener('click', () => {
    isRegisterMode = !isRegisterMode;
    authSubmitBtn.textContent = isRegisterMode ? 'Register' : 'Login';
    toggleRegisterBtn.textContent = isRegisterMode ? 'Switch to Login' : 'Switch to Register';
    clearMessages();
  });

  function clearMessages() {
    messagesDiv.innerHTML = '';
  }

  // Enable or disable upload buttons based on file selection and size
  pfpUploadInput.addEventListener('change', () => {
    const file = pfpUploadInput.files[0];
    if (!file) {
      pfpUploadBtn.disabled = true;
      return;
    }
    if (file.size > 10 * 1024 * 1024) {
      showMessage('Profile picture must be 10MB or smaller');
      pfpUploadBtn.disabled = true;
      return;
    }
    pfpUploadBtn.disabled = false;

    // Show preview
    const reader = new FileReader();
    reader.onload = function(e) {
      pfpPreview.src = e.target.result;
      pfpPreview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  });

  fileUploadInput.addEventListener('change', () => {
    const file = fileUploadInput.files[0];
    if (!file) {
      fileUploadBtn.disabled = true;
      return;
    }
    if (file.size > 125 * 1024 * 1024) {
      showMessage('File must be 125MB or smaller');
      fileUploadBtn.disabled = true;
      return;
    }
    fileUploadBtn.disabled = false;
  });

  // Logout Handler
  logoutBtn.addEventListener('click', () => {
    fetch('/logout', { method: 'POST' })
      .then(res => {
        if (res.ok) {
          location.reload();
        } else {
          showMessage('Failed to logout');
        }
      })
      .catch(() => showMessage('Failed to logout'));
  });

  // Auth form submit
  authForm.addEventListener('submit', e => {
    e.preventDefault();
    clearMessages();

    const username = usernameInput.value.trim();
    const password = passwordInput.value;

    // Validate username pattern (alphanumeric + underscore)
    if (!/^[a-zA-Z0-9_]{3,16}$/.test(username)) {
      showMessage('Username must be 3-16 characters: letters, numbers, underscore only.');
      return;
    }
    if (password.length < 8) {
      showMessage('Password must be at least 8 characters.');
      return;
    }

    const endpoint = isRegisterMode ? '/register' : '/login';

    fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password }),
    })
      .then(async res => {
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.message || 'Unknown error');
        }
        showMessage(data.message || 'Success', 'success');
        if (!isRegisterMode) {
          // Login success
          setupUserPanel(data.user);
        } else {
          // After registration, switch to login mode
          isRegisterMode = false;
          authSubmitBtn.textContent = 'Login';
          toggleRegisterBtn.textContent = 'Switch to Register';
        }
      })
      .catch(err => {
        showMessage(err.message || 'Request failed');
      });
  });

  // Profile picture upload handler
  pfpUploadBtn.addEventListener('click', () => {
    const file = pfpUploadInput.files[0];
    if (!file) {
      showMessage('No profile picture selected');
      return;
    }

    const formData = new FormData();
    formData.append('pfp', file);

    pfpUploadBtn.disabled = true;

    fetch('/upload-pfp', {
      method: 'POST',
      body: formData,
    })
      .then(async res => {
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Upload failed');
        showMessage('Profile picture uploaded!', 'success');
        if (data.pfpUrl) {
          pfpPreview.src = data.pfpUrl + '?' + new Date().getTime(); // prevent cache
          pfpPreview.style.display = 'block';
        }
      })
      .catch(err => showMessage(err.message || 'Upload failed'))
      .finally(() => {
        pfpUploadBtn.disabled = false;
        pfpUploadInput.value = '';
      });
  });

  // General file upload handler
  fileUploadBtn.addEventListener('click', () => {
    const file = fileUploadInput.files[0];
    if (!file) {
      showMessage('No file selected');
      return;
    }
    const formData = new FormData();
    formData.append('file', file);

    fileUploadBtn.disabled = true;

    fetch('/upload-file', {
      method: 'POST',
      body: formData,
    })
      .then(async res => {
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Upload failed');
        showMessage('File uploaded successfully!', 'success');
      })
      .catch(err => showMessage(err.message || 'Upload failed'))
      .finally(() => {
        fileUploadBtn.disabled = false;
        fileUploadInput.value = '';
      });
  });

  // Setup user panel UI after login
  function setupUserPanel(user) {
    authForm.style.display = 'none';
    pfpSection.style.display = 'block';
    fileUploadSection.style.display = 'block';
    userInfoDiv.style.display = 'block';

    displayUsernameSpan.textContent = user.username || 'Unknown User';

    if (user.pfpUrl) {
      pfpPreview.src = user.pfpUrl + '?' + new Date().getTime();
      pfpPreview.style.display = 'block';
    } else {
      pfpPreview.style.display = 'none';
    }
  }

  // Check if already logged in on page load
  function checkSession() {
    fetch('/session')
      .then(res => res.json())
      .then(data => {
        if (data.loggedIn) {
          setupUserPanel(data.user);
        }
      })
      .catch(() => {});
  }

  checkSession();
</script>
</body>
</html>
