<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Panel System</title>
  <style>
    /* Simple styling for layout and visibility */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .hidden {
      display: none;
    }
    #chat-messages {
      border: 1px solid #ccc;
      height: 200px;
      overflow-y: auto;
      padding: 5px;
      background: #f9f9f9;
    }
    #logs {
      border: 1px solid #666;
      height: 150px;
      overflow-y: auto;
      padding: 5px;
      background: #eee;
      white-space: pre-wrap;
      font-family: monospace;
    }
    #avatar-preview {
      max-width: 100px;
      max-height: 100px;
      display: block;
      margin-top: 10px;
      border-radius: 8px;
    }
    .panel {
      margin-top: 20px;
      border: 1px solid #aaa;
      padding: 10px;
      background: #fafafa;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>User Panel System</h1>

  <!-- Login and Register Forms -->
  <div id="auth-container">
    <div id="login-panel">
      <h2>Login</h2>
      <label>
        Username: <input type="text" id="login-username" autocomplete="username" />
      </label><br />
      <label>
        Password: <input type="password" id="login-password" autocomplete="current-password" />
      </label><br />
      <button id="login-btn">Login</button>
      <p>
        Don't have an account? <a href="#" id="show-register">Register here</a>
      </p>
      <div id="login-error" style="color: red;"></div>
    </div>

    <div id="register-panel" class="hidden">
      <h2>Register</h2>
      <label>
        Username (3-16 chars): <input type="text" id="register-username" />
      </label><br />
      <label>
        Password (min 8 chars): <input type="password" id="register-password" />
      </label><br />
      <button id="register-btn">Register</button>
      <p>
        Already have an account? <a href="#" id="show-login">Login here</a>
      </p>
      <div id="register-error" style="color: red;"></div>
    </div>
  </div>

  <!-- User Panel -->
  <div id="user-panel" class="hidden panel" aria-live="polite">
    <h2 id="welcome"></h2>

    <!-- Profile Picture Upload -->
    <section>
      <h3>Upload Profile Icon (max 10MB, any image format)</h3>
      <input type="file" id="avatar" accept="image/*" />
      <button id="upload-btn" disabled>Upload Profile Icon</button>
      <img id="avatar-preview" class="hidden" alt="Profile icon preview" />
    </section>

    <!-- File Upload -->
    <section>
      <h3>Upload Files (max 125MB per file, any type)</h3>
      <input type="file" id="file-upload" multiple />
      <button id="upload-files-btn">Upload Files</button>
    </section>

    <!-- Chat System -->
    <section>
      <h3>Chat</h3>
      <div id="chat-messages" role="log" aria-live="polite" tabindex="0"></div>
      <input type="text" id="chat-input" placeholder="Type message here" aria-label="Chat message input" />
      <button id="send-chat-btn">Send</button>
      <br />
      <label>
        Attach file (max 125MB): <input type="file" id="chat-file" />
      </label>
    </section>

    <!-- Logs (admin/superadmin only) -->
    <section id="logs-section" class="hidden">
      <h3>Login Logs</h3>
      <pre id="logs" tabindex="0" aria-live="polite"></pre>
      <button id="refresh-logs-btn">Refresh Logs</button>
    </section>

    <button id="logout-btn" style="margin-top: 20px;">Logout</button>
  </div>

  <script>
    // === Selectors ===
    const loginPanel = document.getElementById('login-panel');
    const registerPanel = document.getElementById('register-panel');
    const authContainer = document.getElementById('auth-container');
    const userPanel = document.getElementById('user-panel');
    const welcomeEl = document.getElementById('welcome');
    const avatarPreview = document.getElementById('avatar-preview');
    const logsSection = document.getElementById('logs-section');
    const logsPre = document.getElementById('logs');

    // === Show/hide login/register panels ===
    document.getElementById('show-register').addEventListener('click', e => {
      e.preventDefault();
      loginPanel.classList.add('hidden');
      registerPanel.classList.remove('hidden');
      clearErrors();
    });
    document.getElementById('show-login').addEventListener('click', e => {
      e.preventDefault();
      registerPanel.classList.add('hidden');
      loginPanel.classList.remove('hidden');
      clearErrors();
    });

    // === Error Displays ===
    function clearErrors() {
      document.getElementById('login-error').textContent = '';
      document.getElementById('register-error').textContent = '';
    }

    // === Validation ===
    function validateRegister(username, password) {
      if (!username || username.length < 3 || username.length > 16) {
        return 'Username must be between 3 and 16 characters.';
      }
      if (!password || password.length < 8) {
        return 'Password must be at least 8 characters.';
      }
      return null;
    }

    // === Show user panel and role-based UI ===
    function showUserPanel(role, avatarUrl) {
      authContainer.classList.add('hidden');
      userPanel.classList.remove('hidden');
      logsSection.classList.toggle('hidden', !(role === 'admin' || role === 'superadmin'));

      // Load logs if admin or superadmin
      if (role === 'admin' || role === 'superadmin') {
        loadLogs();
      }

      // Set avatar preview if available
      if (avatarUrl) {
        avatarPreview.src = avatarUrl;
        avatarPreview.classList.remove('hidden');
      } else {
        avatarPreview.classList.add('hidden');
      }
      
      // Disable upload button initially
      document.getElementById('upload-btn').disabled = true;

      // Start chat refresh loop (every 5 seconds)
      if (!window.chatInterval) {
        window.chatInterval = setInterval(loadChat, 5000);
      }
    }

    // === Load Logs ===
    async function loadLogs() {
      try {
        const res = await fetch('/logs');
        if (res.ok) {
          const text = await res.text();
          logsPre.textContent = text || 'No logs found.';
        } else {
          logsPre.textContent = 'Failed to load logs.';
        }
      } catch (e) {
        logsPre.textContent = 'Error loading logs.';
      }
    }

    document.getElementById('refresh-logs-btn').addEventListener('click', loadLogs);

    // === Register ===
    document.getElementById('register-btn').addEventListener('click', async () => {
      clearErrors();
      const username = document.getElementById('register-username').value.trim();
      const password = document.getElementById('register-password').value;
      const validationError = validateRegister(username, password);
      if (validationError) {
        document.getElementById('register-error').textContent = validationError;
        return;
      }

      try {
        const res = await fetch('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
        });
        if (res.ok) {
          alert('Registration successful! Please login.');
          document.getElementById('register-username').value = '';
          document.getElementById('register-password').value = '';
          registerPanel.classList.add('hidden');
          loginPanel.classList.remove('hidden');
        } else {
          const data = await res.json();
          document.getElementById('register-error').textContent = data.error || 'Registration failed.';
        }
      } catch (e) {
        document.getElementById('register-error').textContent = 'Error connecting to server.';
      }
    });

    // === Login ===
    document.getElementById('login-btn').addEventListener('click', async () => {
      clearErrors();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      if (!username || !password) {
        document.getElementById('login-error').textContent = 'Username and password required.';
        return;
      }

      try {
        const res = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
        });
        if (res.ok) {
          const data = await res.json();
          welcomeEl.textContent = `Welcome, ${data.username} (${data.role})`;
          showUserPanel(data.role, data.avatarUrl);
          // Clear login form
          document.getElementById('login-username').value = '';
          document.getElementById('login-password').value = '';
          loadChat();
        } else {
          const data = await res.json();
          document.getElementById('login-error').textContent = data.error || 'Login failed.';
        }
      } catch (e) {
        document.getElementById('login-error').textContent = 'Error connecting to server.';
      }
    });

    // === Check if logged in on page load ===
    (async () => {
      try {
        const res = await fetch('/me');
        if (res.ok) {
          const data = await res.json();
          welcomeEl.textContent = `Welcome, ${data.username} (${data.role})`;
          showUserPanel(data.role, data.avatarUrl);
          loadChat();
        } else {
          // Show login by default
          loginPanel.classList.remove('hidden');
          registerPanel.classList.add('hidden');
        }
      } catch {
        loginPanel.classList.remove('hidden');
        registerPanel.classList.add('hidden');
      }
    })();

    // === Logout ===
    document.getElementById('logout-btn').addEventListener('click', async () => {
      try {
        await fetch('/logout', { method: 'POST' });
      } catch {}
      // Reset UI
      userPanel.classList.add('hidden');
      authContainer.classList.remove('hidden');
      loginPanel.classList.remove('hidden');
      registerPanel.classList.add('hidden');
      welcomeEl.textContent = '';
      avatarPreview.classList.add('hidden');
      avatarPreview.src = '';
      if (window.chatInterval) {
        clearInterval(window.chatInterval);
        window.chatInterval = null;
      }
      document.getElementById('chat-messages').textContent = '';
      logsPre.textContent = '';
    });

    // === Avatar Upload Handling ===
    const avatarInput = document.getElementById('avatar');
    const uploadBtn = document.getElementById('upload-btn');

    avatarInput.addEventListener('change', () => {
      const file = avatarInput.files[0];
      if (file && file.size <= 10 * 1024 * 1024) { // 10MB max
        uploadBtn.disabled = false;
      } else {
        uploadBtn.disabled = true;
        if (file) alert('Profile icon must be 10MB or less.');
      }
    });

    uploadBtn.addEventListener('click', async () => {
      const file = avatarInput.files[0];
      if (!file) return;
      if (file.size > 10 * 1024 * 1024) {
        alert('File too large, max 10MB.');
        return;
      }
      try {
        const formData = new FormData();
        formData.append('avatar', file);
        const res = await fetch('/upload-avatar', {
          method: 'POST',
          body: formData,
        });
        if (res.ok) {
          const data = await res.json();
          avatarPreview.src = data.avatarUrl || URL.createObjectURL(file);
          avatarPreview.classList.remove('hidden');
          alert('Profile icon uploaded!');
          avatarInput.value = '';
          uploadBtn.disabled = true;
        } else {
          alert('Failed to upload avatar.');
        }
      } catch (e) {
        alert('Error uploading avatar.');
      }
    });

    // === File Upload Handling ===
    document.getElementById('upload-files-btn').addEventListener('click', async () => {
      const input = document.getElementById('file-upload');
      if (!input.files.length) {
        alert('Please select file(s) to upload.');
        return;
      }
      // Check size per file
      for (const f of input.files) {
        if (f.size > 125 * 1024 * 1024) { // 125MB
          alert(`File "${f.name}" is too large (max 125MB).`);
          return;
        }
      }
      try {
        const formData = new FormData();
        for (const f of input.files) formData.append('files', f);
        const res = await fetch('/upload-files', {
          method: 'POST',
          body: formData,
        });
        if (res.ok) {
          alert(`Uploaded ${input.files.length} file(s) successfully.`);
          input.value = '';
        } else {
          alert('File upload failed.');
        }
      } catch {
        alert('Error uploading files.');
      }
    });

    // === Chat System ===
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendChatBtn = document.getElementById('send-chat-btn');
    const chatFileInput = document.getElementById('chat-file');

    async function loadChat() {
      try {
        const res = await fetch('/chat');
        if (res.ok) {
          const messages = await res.json();
          chatMessages.innerHTML = '';
          // Show last 50 messages
          const lastMessages = messages.slice(-50);
          for (const msg of lastMessages) {
            const div = document.createElement('div');
            div.textContent = `[${new Date(msg.timestamp).toLocaleTimeString()}] ${msg.username}: ${msg.message}`;
            chatMessages.appendChild(div);
          }
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      } catch {
        // ignore errors silently
      }
    }

    sendChatBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    async function sendMessage() {
      const msg = chatInput.value.trim();
      if (!msg && !chatFileInput.files.length) {
        alert('Please enter a message or attach a file.');
        return;
      }

      const formData = new FormData();
      formData.append('message', msg);
      if (chatFileInput.files.length) {
        const file = chatFileInput.files[0];
        if (file.size > 125 * 1024 * 1024) {
          alert('Attached file is too large (max 125MB).');
          return;
        }
        formData.append('file', file);
      }

      try {
        const res = await fetch('/chat', {
          method: 'POST',
          body: formData,
        });
        if (res.ok) {
          chatInput.value = '';
          chatFileInput.value = '';
          loadChat();
        } else {
          alert('Failed to send message.');
        }
      } catch {
        alert('Error sending message.');
      }
    }

    // Disable upload button initially
    uploadBtn.disabled = true;
  </script>
</body>
</html>
