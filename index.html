<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Login/Register Chat Upload</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; }
  #chat, #upload, #logs { display: none; margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
  #logs { max-height: 150px; overflow-y: auto; background: #eee; }
  .hidden { display: none; }
  input, button { padding: 8px; margin: 5px 0; width: 100%; }
  button { cursor: pointer; }
</style>
</head>
<body>

<h1>Login / Register</h1>

<div id="auth-section">
  <input type="text" id="username" placeholder="Username" />
  <input type="password" id="password" placeholder="Password" />
  <button id="login-btn">Login</button>
  <button id="register-btn">Register</button>
  <p id="auth-message" style="color:red;"></p>
</div>

<div id="user-section" class="hidden">
  <h2>Welcome, <span id="display-username"></span>!</h2>
  <button id="logout-btn">Logout</button>
</div>

<div id="chat-upload-section" class="hidden">
  <div id="chat">
    <h3>Chat</h3>
    <div id="chat-messages" style="height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 5px;"></div>
    <input type="text" id="chat-input" placeholder="Type message..." />
    <button id="send-chat-btn">Send</button>
  </div>

  <div id="upload">
    <h3>Upload File</h3>
    <input type="file" id="file-upload" />
    <button id="upload-btn">Upload</button>
    <p id="upload-message" style="color:green;"></p>
  </div>
</div>

<div id="logs" class="hidden">
  <h3>Login Logs (Admin Only)</h3>
  <div id="log-entries"></div>
</div>

<script>
const loginBtn = document.getElementById("login-btn");
const registerBtn = document.getElementById("register-btn");
const logoutBtn = document.getElementById("logout-btn");
const authMessage = document.getElementById("auth-message");
const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");

const authSection = document.getElementById("auth-section");
const userSection = document.getElementById("user-section");
const chatUploadSection = document.getElementById("chat-upload-section");
const logsSection = document.getElementById("logs");

const displayUsername = document.getElementById("display-username");

const chatMessages = document.getElementById("chat-messages");
const chatInput = document.getElementById("chat-input");
const sendChatBtn = document.getElementById("send-chat-btn");

const fileUploadInput = document.getElementById("file-upload");
const uploadBtn = document.getElementById("upload-btn");
const uploadMessage = document.getElementById("upload-message");

const logEntries = document.getElementById("log-entries");

let currentUser = null;
let currentRole = null;

// Helper to show/hide UI sections
function setLoggedInUI(username, role) {
  currentUser = username;
  currentRole = role;
  displayUsername.textContent = username;
  authSection.style.display = "none";
  userSection.classList.remove("hidden");
  chatUploadSection.classList.remove("hidden");
  logoutBtn.style.display = "inline-block";

  if(role === "admin") {
    logsSection.classList.remove("hidden");
    fetchLogs();
  } else {
    logsSection.classList.add("hidden");
  }
}

function logout() {
  currentUser = null;
  currentRole = null;
  displayUsername.textContent = "";
  authSection.style.display = "block";
  userSection.classList.add("hidden");
  chatUploadSection.classList.add("hidden");
  logsSection.classList.add("hidden");
  authMessage.textContent = "";
  usernameInput.value = "";
  passwordInput.value = "";
  chatMessages.innerHTML = "";
  chatInput.value = "";
  uploadMessage.textContent = "";
  logEntries.innerHTML = "";
}

// Login handler
loginBtn.addEventListener("click", async () => {
  const username = usernameInput.value.trim();
  const password = passwordInput.value;
  if(!username || !password) {
    authMessage.textContent = "Please fill username and password";
    return;
  }
  authMessage.textContent = "";

  try {
    const res = await fetch("/api/login", {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({username, password})
    });
    const data = await res.json();
    if(data.success) {
      setLoggedInUI(username, data.role);
    } else {
      authMessage.textContent = data.message;
    }
  } catch(e) {
    authMessage.textContent = "Server error";
  }
});

// Register handler
registerBtn.addEventListener("click", async () => {
  const username = usernameInput.value.trim();
  const password = passwordInput.value;
  if(!username || !password) {
    authMessage.textContent = "Please fill username and password";
    return;
  }
  authMessage.textContent = "";

  try {
    const res = await fetch("/api/register", {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({username, password})
    });
    const data = await res.json();
    if(data.success) {
      authMessage.style.color = "green";
      authMessage.textContent = data.message;
    } else {
      authMessage.style.color = "red";
      authMessage.textContent = data.message;
    }
  } catch(e) {
    authMessage.textContent = "Server error";
  }
});

// Logout button
logoutBtn.addEventListener("click", () => {
  fetch("/api/logout", { method: "POST" }).finally(() => {
    logout();
  });
});

// Send chat message
sendChatBtn.addEventListener("click", async () => {
  const message = chatInput.value.trim();
  if(!message) return;
  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({message})
    });
    const data = await res.json();
    if(data.success) {
      appendChatMessage(data.message);
      chatInput.value = "";
    } else {
      alert(data.message);
    }
  } catch(e) {
    alert("Server error");
  }
});

// Append chat message to chat window
function appendChatMessage(message) {
  const div = document.createElement("div");
  div.textContent = message;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Upload file
uploadBtn.addEventListener("click", async () => {
  if(fileUploadInput.files.length === 0) {
    uploadMessage.style.color = "red";
    uploadMessage.textContent = "Select a file first";
    return;
  }
  const file = fileUploadInput.files[0];
  const formData = new FormData();
  formData.append("file", file);

  uploadMessage.textContent = "";
  try {
    const res = await fetch("/api/upload", {
      method: "POST",
      body: formData
    });
    const data = await res.json();
    if(data.success) {
      uploadMessage.style.color = "green";
      uploadMessage.textContent = data.message;
    } else {
      uploadMessage.style.color = "red";
      uploadMessage.textContent = data.message;
    }
  } catch(e) {
    uploadMessage.style.color = "red";
    uploadMessage.textContent = "Upload failed";
  }
});

// Fetch and display login logs (admin only)
async function fetchLogs() {
  try {
    const res = await fetch("/api/logs");
    const data = await res.json();
    if(data.success) {
      logEntries.innerHTML = data.logs.map(e => `<div>${e}</div>`).join("");
    } else {
      logEntries.innerHTML = "<div>No logs available or unauthorized</div>";
    }
  } catch {
    logEntries.innerHTML = "<div>Error loading logs</div>";
  }
}

// Auto check login status on page load
async function checkSession() {
  try {
    const res = await fetch("/api/session");
    const data = await res.json();
    if(data.loggedIn) {
      setLoggedInUI(data.username, data.role);
    }
  } catch {}
}

checkSession();

</script>

</body>
</html>
