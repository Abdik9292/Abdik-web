<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>User Panel System</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
  #container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
  form { margin-bottom: 20px; }
  input, button, select, textarea { width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box; }
  #chatMessages { height: 300px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; background: #fafafa; }
  #chatMessages div { margin-bottom: 8px; }
  .message-user { font-weight: bold; }
  .message-text { margin-left: 10px; }
  #uploadFileLabel, #uploadPfpLabel {
    display: inline-block;
    margin-top: 10px;
    background: #007bff;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
  }
  #uploadFile, #uploadPfp { display: none; }
  #logoutBtn { margin-top: 10px; background: #dc3545; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; }
</style>
</head>
<body>
<div id="container">
  <h2>User Panel System</h2>

  <div id="authSection">
    <h3>Login</h3>
    <form id="loginForm">
      <input type="text" id="loginUsername" placeholder="Username" required minlength="3" maxlength="16" />
      <input type="password" id="loginPassword" placeholder="Password" required minlength="8" />
      <button type="submit">Login</button>
    </form>
    <p>Or <a href="#" id="showRegister">Register here</a></p>
  </div>

  <div id="registerSection" style="display:none;">
    <h3>Register</h3>
    <form id="registerForm">
      <input type="text" id="registerUsername" placeholder="Username (3-16 chars)" required minlength="3" maxlength="16" />
      <input type="password" id="registerPassword" placeholder="Password (min 8 chars)" required minlength="8" />
      <button type="submit">Register</button>
    </form>
    <p>Already have an account? <a href="#" id="showLogin">Login here</a></p>
  </div>

  <div id="userPanel" style="display:none;">
    <h3>Welcome, <span id="usernameDisplay"></span> (<span id="roleDisplay"></span>)</h3>

    <button id="logoutBtn">Logout</button>

    <h4>Profile Picture</h4>
    <label id="uploadPfpLabel" for="uploadPfp">Upload Profile Picture (Max 10MB)</label>
    <input type="file" id="uploadPfp" accept="image/*" />

    <h4>Chat</h4>
    <div id="chatMessages"></div>

    <form id="chatForm">
      <textarea id="chatInput" placeholder="Type your message here..." rows="3" maxlength="1000"></textarea>
      <label id="uploadFileLabel" for="uploadFile">Attach File (Max 125MB)</label>
      <input type="file" id="uploadFile" />
      <button type="submit">Send</button>
    </form>

    <div id="adminLogsSection" style="display:none;">
      <h4>Admin Login Logs</h4>
      <pre id="adminLogs"></pre>
    </div>

    <div id="superadminLogsSection" style="display:none;">
      <h4>Superadmin Login Logs</h4>
      <pre id="superadminLogs"></pre>
    </div>
  </div>
</div>

<script>
  const authSection = document.getElementById('authSection');
  const registerSection = document.getElementById('registerSection');
  const userPanel = document.getElementById('userPanel');
  const usernameDisplay = document.getElementById('usernameDisplay');
  const roleDisplay = document.getElementById('roleDisplay');
  const chatMessages = document.getElementById('chatMessages');
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');
  const uploadFile = document.getElementById('uploadFile');
  const uploadPfp = document.getElementById('uploadPfp');
  const adminLogsSection = document.getElementById('adminLogsSection');
  const adminLogs = document.getElementById('adminLogs');
  const superadminLogsSection = document.getElementById('superadminLogsSection');
  const superadminLogs = document.getElementById('superadminLogs');

  // Toggle between login/register
  document.getElementById('showRegister').addEventListener('click', e => {
    e.preventDefault();
    authSection.style.display = 'none';
    registerSection.style.display = 'block';
  });
  document.getElementById('showLogin').addEventListener('click', e => {
    e.preventDefault();
    registerSection.style.display = 'none';
    authSection.style.display = 'block';
  });

  // Check if logged in on page load
  async function checkLogin() {
    const res = await fetch('/api/me');
    if (res.ok) {
      const user = await res.json();
      showUserPanel(user);
      fetchChatMessages();
      if(user.role === 'admin' || user.role === 'superadmin') loadAdminLogs();
      if(user.role === 'superadmin') loadSuperadminLogs();
    } else {
      showLoginForm();
    }
  }

  function showLoginForm() {
    authSection.style.display = 'block';
    registerSection.style.display = 'none';
    userPanel.style.display = 'none';
  }

  function showUserPanel(user) {
    authSection.style.display = 'none';
    registerSection.style.display = 'none';
    userPanel.style.display = 'block';
    usernameDisplay.textContent = user.username;
    roleDisplay.textContent = user.role;

    if(user.role === 'admin' || user.role === 'superadmin') {
      adminLogsSection.style.display = 'block';
    }
    if(user.role === 'superadmin') {
      superadminLogsSection.style.display = 'block';
    }
  }

  // Login form submit
  document.getElementById('loginForm').addEventListener('submit', async e => {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const res = await fetch('/api/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ username, password })
    });
    if(res.ok) {
      const user = await res.json();
      showUserPanel(user);
      fetchChatMessages();
      if(user.role === 'admin' || user.role === 'superadmin') loadAdminLogs();
      if(user.role === 'superadmin') loadSuperadminLogs();
    } else {
      alert('Login failed');
    }
  });

  // Register form submit
  document.getElementById('registerForm').addEventListener('submit', async e => {
    e.preventDefault();
    const username = document.getElementById('registerUsername').value.trim();
    const password = document.getElementById('registerPassword').value;
    const res = await fetch('/api/register', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ username, password })
    });
    if(res.ok) {
      alert('Registration successful. You can now log in.');
      registerSection.style.display = 'none';
      authSection.style.display = 'block';
    } else {
      const err = await res.json();
      alert('Registration failed: ' + (err.error || 'Unknown error'));
    }
  });

  // Logout button
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await fetch('/api/logout', { method: 'POST' });
    showLoginForm();
  });

  // Fetch chat messages and show
  async function fetchChatMessages() {
    const res = await fetch('/api/chat/messages');
    if(res.ok) {
      const messages = await res.json();
      chatMessages.innerHTML = '';
      for(const msg of messages) {
        const div = document.createElement('div');
        div.innerHTML = `<span class="message-user">${msg.username}:</span> <span class="message-text">${escapeHtml(msg.message)}</span>` +
          (msg.fileUrl ? ` <a href="${msg.fileUrl}" target="_blank">(file)</a>` : '') +
          (msg.pfpFilename ? ` <img src="/uploads/pfps/${msg.pfpFilename}" alt="pfp" style="width:20px;height:20px;border-radius:50%;vertical-align:middle;">` : '');
        chatMessages.appendChild(div);
      }
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, (m) => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[m]);
  }

  // Chat form submit (send message + optional file)
  chatForm.addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData();
    const msg = chatInput.value.trim();
    if (!msg && uploadFile.files.length === 0) {
      alert('Please enter a message or attach a file');
      return;
    }
    formData.append('message', msg);
    if(uploadFile.files.length > 0) formData.append('file', uploadFile.files[0]);

    const res = await fetch('/api/chat/send', {
      method: 'POST',
      body: formData
    });
    if(res.ok) {
      chatInput.value = '';
      uploadFile.value = '';
      fetchChatMessages();
    } else {
      alert('Failed to send message');
    }
  });

  // Profile picture upload
  uploadPfp.addEventListener('change', async () => {
    if(uploadPfp.files.length === 0) return;
    const file = uploadPfp.files[0];
    if(file.size > 10 * 1024 * 1024) {
      alert('Profile picture must be under 10MB');
      return;
    }
    const formData = new FormData();
    formData.append('pfp', file);
    const res = await fetch('/api/upload/pfp', {
      method: 'POST',
      body: formData
    });
    if(res.ok) {
      alert('Profile picture uploaded!');
      fetchChatMessages(); // refresh to show pfp in chat
    } else {
      alert('Failed to upload profile picture');
    }
  });

  // Load admin logs
  async function loadAdminLogs() {
    const res = await fetch('/api/admin/logs');
    if(res.ok) {
      const logs = await res.json();
      adminLogs.textContent = JSON.stringify(logs, null, 2);
    }
  }
  // Load superadmin logs
  async function loadSuperadminLogs() {
    const res = await fetch('/api/superadmin/logs');
    if(res.ok) {
      const logs = await res.json();
      superadminLogs.textContent = JSON.stringify(logs, null, 2);
    }
  }

  // Initial check for session
  checkLogin();

  // Optional: Poll chat messages every 10 seconds
  setInterval(fetchChatMessages, 10000);
</script>
</body>
</html>
