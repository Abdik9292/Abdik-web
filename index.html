<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Abdik-web Panel</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; }
  #loginForm, #panel { border: 1px solid #ccc; padding: 15px; border-radius: 5px; }
  #chat { height: 200px; overflow-y: auto; border: 1px solid #ccc; margin-bottom: 10px; padding: 5px; background: #f9f9f9; }
  #chat div { margin-bottom: 5px; }
  #uploadForm { margin-top: 15px; }
  button { cursor: pointer; }
</style>
</head>
<body>

<div id="loginForm">
  <h2>Login</h2>
  <form id="formLogin">
    <label>Username:<br /><input type="text" id="username" required /></label><br /><br />
    <label>Password:<br /><input type="password" id="password" required /></label><br /><br />
    <button type="submit">Login</button>
  </form>
  <div id="loginError" style="color:red; margin-top:10px;"></div>
</div>

<div id="panel" style="display:none;">
  <h2 id="panelTitle"></h2>
  <p>Welcome, <span id="userDisplay"></span> (<span id="roleDisplay"></span>)</p>
  <button id="btnLogout">Logout</button>

  <h3>Chat</h3>
  <div id="chat"></div>
  <form id="formChat">
    <input id="chatInput" autocomplete="off" placeholder="Type a message" required />
    <button type="submit">Send</button>
  </form>

  <h3>Upload File</h3>
  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" id="uploadFile" required />
    <button type="submit">Upload</button>
  </form>
  <div id="uploadStatus" style="margin-top:10px;"></div>
</div>

<script>
  const API_BASE = "/Abdik-web/api";

  // Check if logged in (session or localStorage)
  let currentUser = null;
  let currentRole = null;

  function showLogin(errorMsg) {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('panel').style.display = 'none';
    document.getElementById('loginError').textContent = errorMsg || '';
  }

  function showPanel(user, role) {
    currentUser = user;
    currentRole = role;

    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('panel').style.display = 'block';
    document.getElementById('userDisplay').textContent = user;
    document.getElementById('roleDisplay').textContent = role;
    document.getElementById('panelTitle').textContent = role === "admin" ? "Admin Panel" : "User Panel";

    fetchMessages();
    if (!window.chatInterval) {
      window.chatInterval = setInterval(fetchMessages, 1000);
    }
  }

  async function login(username, password) {
    const formData = new URLSearchParams();
    formData.append('username', username);
    formData.append('password', password);

    const res = await fetch(API_BASE + "/login", {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: formData.toString()
    });
    const data = await res.json();
    return data;
  }

  async function logout() {
    await fetch(API_BASE + "/logout", { method: "POST" });
    currentUser = null;
    currentRole = null;
    clearInterval(window.chatInterval);
    window.chatInterval = null;
    showLogin();
  }

  // Chat
  async function fetchMessages() {
    const res = await fetch(API_BASE + "/chat/messages");
    if (res.status === 403) {
      await logout();
      return;
    }
    const messages = await res.json();
    const chatDiv = document.getElementById('chat');
    chatDiv.innerHTML = messages.map(m => `<div><b>${m.username}:</b> ${escapeHtml(m.message)}</div>`).join('');
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  async function sendMessage(message) {
    const formData = new URLSearchParams();
    formData.append('message', message);

    const res = await fetch(API_BASE + "/chat/send", {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: formData.toString()
    });
    const data = await res.json();
    if (!data.success) {
      alert("Failed to send message: " + (data.error || "Unknown error"));
    }
  }

  // Upload
  async function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);

    const res = await fetch('/Abdik-web/upload', {
      method: 'POST',
      body: formData
    });
    const text = await res.text();
    document.getElementById('uploadStatus').innerHTML = text;
  }

  // Utils
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Event listeners
  document.getElementById('formLogin').addEventListener('submit', async e => {
    e.preventDefault();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    if (!username || !password) {
      showLogin("Please enter username and password.");
      return;
    }

    const data = await login(username, password);
    if (data.success) {
      showPanel(username, data.role);
    } else {
      showLogin(data.error || "Login failed.");
    }
  });

  document.getElementById('btnLogout').addEventListener('click', async () => {
    await logout();
  });

  document.getElementById('formChat').addEventListener('submit', async e => {
    e.preventDefault();
    const input = document.getElementById('chatInput');
    const msg = input.value.trim();
    if (!msg) return;
    await sendMessage(msg);
    input.value = '';
  });

  document.getElementById('uploadForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fileInput = document.getElementById('uploadFile');
    if (fileInput.files.length === 0) {
      alert("Please select a file.");
      return;
    }
    await uploadFile(fileInput.files[0]);
    fileInput.value = '';
  });

  // On page load
  showLogin();

</script>
</body>
</html>
